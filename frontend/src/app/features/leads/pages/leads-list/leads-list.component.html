<div class="container">
  <div class="card-header">
    <h1>Gerenciamento de Leads</h1>
    <p-button
      label="Novo Lead"
      icon="pi pi-plus"
      (onClick)="openNew()"
    ></p-button>
  </div>

  <div class="grid mb-4">
    <div class="col-12 md:col-4">
        <input
          pInputText
          type="text"
          [(ngModel)]="filterNome"
          (input)="loadLeads()"
          placeholder="Buscar por nome"
          class="w-full"
        />
    </div>
    <div class="col-12 md:col-4">
      <p-select
        [options]="statusOptions"
        [(ngModel)]="filterStatus"
        (onChange)="loadLeads()"
        placeholder="Filtrar por status"
        optionLabel="label"
        optionValue="value"
        [showClear]="true"
        class="w-full"
      />
    </div>
    <div class="col-12 md:col-4">
      <input
        pInputText
        type="text"
        [(ngModel)]="filterMunicipio"
        (input)="loadLeads()"
        placeholder="Buscar por município"
        class="w-full"
      />
    </div>
  </div>

  <p-table
    [value]="leads"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} leads"
    [tableStyle]="{ 'min-width': '50rem' }"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Nome</th>
        <th>Status</th>
        <th>Município</th>
        <th>Propriedades</th>
        <th>Área Total (ha)</th>
        <th>Ações</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-lead>
      <tr>
        <td>{{ lead.nome }}</td>
        <td>
          <p-tag
            [severity]="getStatusSeverity(lead.status)"
            [value]="formatStatus(lead.status)"
          ></p-tag>
        </td>
        <td>{{ lead.municipio || '-' }}</td>
        <td>
          <span *ngIf="lead.properties && lead.properties.length > 0">
            {{ lead.properties.length }}
          </span>
          <span *ngIf="!lead.properties || lead.properties.length === 0">
            0
          </span>
        </td>
        <td>
          <span *ngIf="lead.properties && lead.properties.length > 0">
            {{ getTotalArea(lead) | number : '1.2-2' }}
            <i
              *ngIf="isPriority(lead)"
              class="pi pi-star ml-2"
              style="color: gold"
              pTooltip="Lead Prioritário (> 100 ha)"
            ></i>
          </span>
          <span *ngIf="!lead.properties || lead.properties.length === 0">
            0
          </span>
        </td>
        <td>
          <p-button
            icon="pi pi-eye"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            (onClick)="viewLead(lead.id!)"
            pTooltip="Ver detalhes"
          ></p-button>
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            [text]="true"
            severity="info"
            (onClick)="editLead(lead)"
            pTooltip="Editar"
          ></p-button>
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            severity="danger"
            (onClick)="deleteLead(lead)"
            pTooltip="Excluir"
          ></p-button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">Nenhum lead encontrado</td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    [(visible)]="displayDialog"
    [header]="selectedLead ? 'Editar Lead' : 'Novo Lead'"
    [modal]="true"
    [style]="{ width: '50vw' }"
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
  >
    <app-lead-form
      [lead]="selectedLead"
      (save)="onSave()"
      (cancel)="onCancel()"
    ></app-lead-form>
  </p-dialog>

  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>
</div>

